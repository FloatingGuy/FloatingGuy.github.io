<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>XNU内核设计--Kext内核扩展 | FloatingGuy's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">XNU内核设计--Kext内核扩展</h1><a id="logo" href="/.">FloatingGuy's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">XNU内核设计--Kext内核扩展</h1><div class="post-meta">Mar 15, 2017<span> | </span><span class="category"><a href="/categories/读书/">读书</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2017/03/15/XNU内核设计-Kext内核扩展/" href="/2017/03/15/XNU内核设计-Kext内核扩展/#comments" class="ds-thread-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#kext-基本信息"><span class="toc-number">1.</span> <span class="toc-text">kext 基本信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#特殊的-kext-介绍"><span class="toc-number">2.</span> <span class="toc-text">特殊的 kext 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kext-基本结构"><span class="toc-number">3.</span> <span class="toc-text">kext 基本结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从kernelcache-提取-kext"><span class="toc-number">4.</span> <span class="toc-text">从kernelcache 提取 kext</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OSX-提取-kernelcache-实验"><span class="toc-number">4.1.</span> <span class="toc-text">OSX 提取 kernelcache 实验</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#multi-kext"><span class="toc-number">5.</span> <span class="toc-text">multi-kext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kext-开发"><span class="toc-number">6.</span> <span class="toc-text">Kext 开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kext-的内核支持"><span class="toc-number">7.</span> <span class="toc-text">Kext 的内核支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#kmod-支持（已废弃）"><span class="toc-number">7.1.</span> <span class="toc-text">kmod 支持（已废弃）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#libkern-支持-kext"><span class="toc-number">7.2.</span> <span class="toc-text">libkern 支持 kext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kext-加载的原理"><span class="toc-number">7.3.</span> <span class="toc-text">kext 加载的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#调试-kext-request"><span class="toc-number">7.4.</span> <span class="toc-text">调试 kext_request</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kext-相关工具"><span class="toc-number">8.</span> <span class="toc-text">kext 相关工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第三方工具"><span class="toc-number">8.1.</span> <span class="toc-text">第三方工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#常用命令"><span class="toc-number">8.2.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kextstat"><span class="toc-number">8.3.</span> <span class="toc-text">kextstat</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zprint"><span class="toc-number">8.4.</span> <span class="toc-text">zprint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Change-Log"><span class="toc-number">9.</span> <span class="toc-text">Change Log</span></a></li></ol></div></div><div class="post-content"><p>作者：FloatingGuy 转载请注明出处：<a href="https://floatingguy.github.io/" target="_blank" rel="external">https://floatingguy.github.io/</a></p>
<hr>
<a id="more"></a>
<p>作者：FloatingGuy 转载请注明出处：<a href="https://floatingguy.github.io/" target="_blank" rel="external">https://floatingguy.github.io/</a></p>
<hr>
<blockquote>
<p>《深入解析MAC OS X &amp; iOS 操作系统》- 第 十八 章: 内核扩展模块</p>
</blockquote>
<!---more-->
<h3 id="kext-基本信息"><a href="#kext-基本信息" class="headerlink" title="kext 基本信息"></a>kext 基本信息</h3><p>kext 的属性：</p>
<ul>
<li>所有者 uid 必须是 root, gid必须是 wheel</li>
<li>文件权限不得超过 644</li>
<li>目录权限不得超过 755</li>
</ul>
<p>预链接：</p>
<h3 id="特殊的-kext-介绍"><a href="#特殊的-kext-介绍" class="headerlink" title="特殊的 kext 介绍"></a>特殊的 kext 介绍</h3><p>书中介绍了一个 用来解密的二进制文件的 kext - Dont Steal Mac OS X.kext (DSMOS).<br>苹果系统于苹果机器EFI模块之间的通信加解密。<br>iOS上的 IOTextEncryptionFamily 用来代替 DSMOS。</p>
<p>在<a href="http://im7ye.lofter.com/post/2c991a_bc8a9f" target="_blank" rel="external">网上收集</a>到一些特殊的 kext。</p>
<ul>
<li>System.kext  最基础的核心系统驱动,mach核心最先载入的驱动,负责于其他扩展通信,</li>
</ul>
<h3 id="kext-基本结构"><a href="#kext-基本结构" class="headerlink" title="kext 基本结构"></a>kext 基本结构</h3><table>
<thead>
<tr>
<th>文件/目录</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>MacOS</td>
<td>保存二进制文件</td>
</tr>
<tr>
<td>PlugIns</td>
<td>存放相关的 kext</td>
</tr>
<tr>
<td>Info.plist</td>
<td>。。</td>
</tr>
</tbody>
</table>
<p>上面几个文件是 bundle 中必备的，其他还有一些文件。</p>
<h3 id="从kernelcache-提取-kext"><a href="#从kernelcache-提取-kext" class="headerlink" title="从kernelcache 提取 kext"></a>从kernelcache 提取 kext</h3><p>OSX 中 kernelcache提供了完整的内核（包括内核+kext+驱动），预加载必要的驱动，加快启动速度。<br>iOS 中 kernelcache只包含要加载的 kext（不包含内核）。</p>
<p>OSX &amp; iOS kernelcache 实现对比</p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th><code>/System/Library/Caches/*</code></th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>OSX</td>
<td>com.apple.kext.caches/Startup</td>
<td>胖二进制格式，offset==384处是 complzss</td>
</tr>
<tr>
<td>iOS</td>
<td>com.apple.kernelcaches/kernelcache</td>
<td><strong>IMG3 加密</strong>的 kernelcache,采用 complzss压缩</td>
</tr>
</tbody>
</table>
<p>OSX kernelcache 动态创建，iOS是固定的并且根据机型 定制。</p>
<blockquote>
<p>6.5.2节 给出了OSX与iOS提取kernelcache 的方法。</p>
</blockquote>
<p>作者提供了一个工具joker<br><code>-dec: Decompress kernelcache to /tmp/kernel (complzss only at this stage) 集合了decache shell 脚本</code> 可以用来查看 iOS中的 kext 列表，前提是要先解压、解密kernelcache。(在10.12 上测试了下，貌似工具有 bug)</p>
<p>胖文件头 签名：0xcafebabe<br>Mach-O签名：0xfeedface(32位)或0xfeedfacf(64位)</p>
<p>从 kernelcache 中提取各个 kext 的步骤：</p>
<ol>
<li>根据偏移找到解压标记位，解压（ios需要解密）</li>
<li>otool提取 __PRELINK_TEXT 段 （此段加载了 所有的内核扩展）<br>上面提取的是 kext bundle 列表， 每个 bundle 是 Mach-o Bundle， 通过签名(0xfeedfacf)识别。</li>
<li>kernelcache 对应的属性列表 plist 包含在 PRELINK_INFO 段中。使用 jtool（segedit）提取。kernelcache的plist是ASCII 格式的文本，其中包含了所有 bundle 的 info.plist。</li>
<li>完成提取</li>
</ol>
<p>插播一句：github上有个项目–machkextdump是dump Kext information 从Macos/iOS系统中,主要是帮助逆向分析用的。</p>
<p>表 18-7  kernelcache plist 文件属性<br><img src="/include/img/bk-xnu/kernelcache-plist.png" alt="kernelcache-plist"></p>
<h4 id="OSX-提取-kernelcache-实验"><a href="#OSX-提取-kernelcache-实验" class="headerlink" title="OSX 提取 kernelcache 实验"></a>OSX 提取 kernelcache 实验</h4><p><img src="/include/img/bk-xnu/original-osx-kernelcache.png" alt="original-osx-kernelcache"></p>
<p><img src="/include/img/bk-xnu/thincache.png" alt="thincache.png"><br>这一步该解压了，但是在10.12 上没有 complzss解压工具（需要自己从源码编译），并且发现压缩签名变成了”complzvn”，需要去查看下10.12 的 xnu 代码。</p>
<p><img src="/include/img/bk-xnu/book-pic.png" alt="first step"><br>从作者的截图中知道，第一步完成以后是一个 Mach-O的可执行文件。</p>
<h3 id="multi-kext"><a href="#multi-kext" class="headerlink" title="multi-kext"></a>multi-kext</h3><p>multi-kext （简称 mkext）是不同于 kernelcache的另一种 预链接形式,mkext不包含内核。</p>
<p>mkext 的签名是”MKXTMOSX”。<br>mkext 头部结构：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint32_t</span>      magic;       \  MKXT</div><div class="line"><span class="keyword">uint32_t</span>      signature;   \  MOSX</div><div class="line"><span class="keyword">uint32_t</span>      length;      \  mkext 文件大小</div><div class="line"><span class="keyword">uint32_t</span>      adler32;     \  从 version 到文件尾的校验值</div><div class="line"><span class="keyword">uint32_t</span>      version;     \</div><div class="line"><span class="keyword">uint32_t</span>      numkexts;    \  kext的数量</div><div class="line"><span class="keyword">cpu_type_t</span>    cputype;     \  CPU_TYPE_ANY</div><div class="line"><span class="keyword">cpu_subtype_t</span> cpusubtype;     CPU_SUBTYPE_MULTIPLE</div></pre></td></tr></table></figure></p>
<p>在后文分析kext_request 源代码时，就是针对 mkext 格式分析其 load等具体操作流程。</p>
<h3 id="Kext-开发"><a href="#Kext-开发" class="headerlink" title="Kext 开发"></a>Kext 开发</h3><p>在我的 <a href="https://floatingguy.github.io/2017/03/16/OSX-FirstExtension-%E5%BC%80%E5%8F%91/" target="_blank" rel="external">《OSX FirstExtension 开发》</a>这篇文章中介绍了，如何开发Kext 代码和遇到的问题。</p>
<h3 id="Kext-的内核支持"><a href="#Kext-的内核支持" class="headerlink" title="Kext 的内核支持"></a>Kext 的内核支持</h3><p>kext 是在内核态链接。内核态内存默认是 <strong>联动内存？？</strong>，消耗物理内存。 （不明白 啥叫联动内存）</p>
<p>kext 是 XNU 独立组件，相对 Mach 和 BSD 都是独立的。管理 kext 部分的代码在 XNU 中是采用 C++ 开发，并且 I/O Kit也是基于 kext 构建。</p>
<h4 id="kmod-支持（已废弃）"><a href="#kmod-支持（已废弃）" class="headerlink" title="kmod 支持（已废弃）"></a>kmod 支持（已废弃）</h4><p>我们上面 提到了 Mach 和 Kext 是独立的，这个说法是有点问题。因为 Mach 是 XNU 的核心，kext 只是xnu 的一部分，所以 Mach 必然要将 kext 也加入它的理念中(《XNU内核设计–Mach-IPC原理》文章介绍了 Mach的理念)。</p>
<p>Mach的一般做法就是给 内核组件定义 对象, 然后定义一些管理的API。</p>
<ul>
<li>Mach 给 kext 定义了 <code>kmod_info</code>结构体，在<code>osfmk/kern/kmod.h</code>。</li>
<li>在老版本 XNU 代码中 <code>osfmk/kern/kmod.c</code> 中包含大量 kmod 处理代码，包括 <code>kmod_create、kmod_destroy</code>等。目前在10.12 代码中这些函数包括<code>kmod_get_info()</code>都只返回一个 KERN_NOT_SUPPORTED。</li>
</ul>
<h4 id="libkern-支持-kext"><a href="#libkern-支持-kext" class="headerlink" title="libkern 支持 kext"></a>libkern 支持 kext</h4><p>虽然 kmod 框架已经废弃（文件还在 xnu 中）并且定义的 API 都废弃了。 但是 mach 中定义的 kmod_info_t 结构体还沿用至今。目前XNU 管理 kext的代码已经转移到libkern目录下， 并用 C++ 重写对 kext 的支持,相关代码在<code>libkern/c++/OSKext.cpp 中</code></p>
<p>kmod_info_t 是每一个 kext 在入口点接受的一个参数。创建 kext 时， xcode 会通过 KMOD_EXPLICIT_DECL 宏为这个 kext 初始化一个 kmode_info_t数据，保存在<code>/Xcode/DerivedData/&lt;moduleNmae&gt;_info.c 文件中</code> 然而 并不知道 这个 kmod_info 在新的 libkern框架中有什么用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> kmod_info &#123;</div><div class="line">    <span class="keyword">struct</span> kmod_info  * next;</div><div class="line">    <span class="keyword">int32_t</span>             info_version;           <span class="comment">// version of this structure</span></div><div class="line">    <span class="keyword">uint32_t</span>            id;</div><div class="line">    <span class="keyword">char</span>                name[KMOD_MAX_NAME];</div><div class="line">    <span class="keyword">char</span>                version[KMOD_MAX_NAME];</div><div class="line">    <span class="keyword">int32_t</span>             reference_count;        <span class="comment">// # linkage refs to this</span></div><div class="line">    <span class="keyword">kmod_reference_t</span>  * reference_list;         <span class="comment">// who this refs (links on)</span></div><div class="line">    <span class="keyword">vm_address_t</span>        address;                <span class="comment">// starting address</span></div><div class="line">    <span class="keyword">vm_size_t</span>           size;                   <span class="comment">// total size</span></div><div class="line">    <span class="keyword">vm_size_t</span>           hdr_size;               <span class="comment">// unwired hdr size</span></div><div class="line">    <span class="keyword">kmod_start_func_t</span> * start;      <span class="comment">// kext 入口</span></div><div class="line">    <span class="keyword">kmod_stop_func_t</span>  * stop;       <span class="comment">// kext 出口</span></div><div class="line">&#125; <span class="keyword">kmod_info_t</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KMOD_DECL(name, version)                                  \</span></div><div class="line">    static kmod_start_func_t name ## _module_start;               \</div><div class="line">    static kmod_stop_func_t  name ## _module_stop;                \</div><div class="line">    kmod_info_t KMOD_INFO_NAME = &#123; 0, KMOD_INFO_VERSION, -1U,      \</div><div class="line">                       &#123; #name &#125;, &#123; version &#125;, -1, 0, 0, 0, 0,    \</div><div class="line">                           name ## _module_start,                 \</div><div class="line">                           name ## _module_stop &#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KMOD_EXPLICIT_DECL(name, version, start, stop)            \</span></div><div class="line">    kmod_info_t KMOD_INFO_NAME = &#123; 0, KMOD_INFO_VERSION, -1U,      \</div><div class="line">                       &#123; #name &#125;, &#123; version &#125;, -1, 0, 0, 0, 0,    \</div><div class="line">                           start, stop &#125;;</div></pre></td></tr></table></figure>
<p>看下xcode 给 FirstExtension.kext 生成 kmod_info 结构体的代码。<br><code>/Users/xxx/Library/Developer/Xcode/DerivedData/FirstExtension-caeeqdglmmdwxqajtyioipnqbieo/Build/Intermediates/FirstExtension.build/Release/FirstExtension.build/DerivedSources/FirstExtension_info.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach/mach_types.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">extern</span> <span class="keyword">kern_return_t</span> _start(<span class="keyword">kmod_info_t</span> *ki, <span class="keyword">void</span> *data);</div><div class="line"><span class="keyword">extern</span> <span class="keyword">kern_return_t</span> _stop(<span class="keyword">kmod_info_t</span> *ki, <span class="keyword">void</span> *data);</div><div class="line">__<span class="function">private_extern__ kern_return_t <span class="title">FirstExtension_start</span><span class="params">(<span class="keyword">kmod_info_t</span> *ki, <span class="keyword">void</span> *data)</span></span>;</div><div class="line">__<span class="function">private_extern__ kern_return_t <span class="title">FirstExtension_stop</span><span class="params">(<span class="keyword">kmod_info_t</span> *ki, <span class="keyword">void</span> *data)</span></span>;</div><div class="line"></div><div class="line">__attribute__((visibility(<span class="string">"default"</span>))) KMOD_EXPLICIT_DECL(com.xxx.FirstExtension, <span class="string">"1.0.0d1"</span>, _start, _stop)</div><div class="line">__private_extern__ <span class="keyword">kmod_start_func_t</span> *_realmain = FirstExtension_start;</div><div class="line">__private_extern__ <span class="keyword">kmod_stop_func_t</span> *_antimain = FirstExtension_stop;</div><div class="line">__private_extern__ <span class="keyword">int</span> _kext_apple_cc = __APPLE_CC__ ;</div></pre></td></tr></table></figure>
<p>就是用来注册 kext 的入口函数和出口函数到 kmod_info 结构体中。</p>
<p>kextd 守护进程：该进程是 内核态和用户态的桥梁,辅助完成 kext 的加载和依赖性解析。<br>kexd 被 launchd 加载时注册了 <strong>主机特殊端口</strong>  host port #15(HOST_KEXTD_PORT)。<br>kexd 和用户态进程（客户端）通过 mach 消息通信<a href="https://floatingguy.github.io/2017/02/27/mach-port-names-%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90/" target="_blank" rel="external">MIG 子系统 70000</a>。<br>iOS 没有 kextd。</p>
<p>IOKit 框架提供了一套 API 封装了和 texd 交互的消息发送和接受。<br>还有一些 API 给 kextd使用，用来和内核直接交互。<br>IOKit 框架API, 表18-8.</p>
<ul>
<li>OSKextLoad</li>
<li>OSKextLoadWithOptions</li>
<li>OSKextUnload</li>
<li>OSKextStart</li>
<li>OSKextStop</li>
<li>OSKextIsStarted</li>
<li>OSKextCopyLoadedKextInfo</li>
</ul>
<p>上述的 API 都是用户态的。</p>
<h4 id="kext-加载的原理"><a href="#kext-加载的原理" class="headerlink" title="kext 加载的原理"></a>kext 加载的原理</h4><p><img src="/include/img/bk-xnu/kext_request.png" alt="OSKext::kext_request"><br>害怕在代码中迷路的同学，先来 看下流程图吧。</p>
<p>上面提到 kext 的加载机制使用了 Mach 消息，所有的 kext 操作都封装为序列化的 XML 格式，并放在 Mach kext_request 消息的 ool_descriptors 数据中。<br>下面分析 内核中kext_request 函数如何处理 kext 加载。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">kern_return_t</span> kext_request(</div><div class="line">    <span class="keyword">host_priv_t</span>                             hostPriv,</div><div class="line">    <span class="comment">/* in only */</span>  <span class="keyword">uint32_t</span>                 clientLogSpec,</div><div class="line">    <span class="comment">/* in only */</span>  <span class="keyword">vm_offset_t</span>              requestIn,</div><div class="line">    <span class="comment">/* in only */</span>  <span class="keyword">mach_msg_type_number_t</span>   requestLengthIn,</div><div class="line">    <span class="comment">/* out only */</span> <span class="keyword">vm_offset_t</span>            * responseOut,</div><div class="line">    <span class="comment">/* out only */</span> <span class="keyword">mach_msg_type_number_t</span> * responseLengthOut,</div><div class="line">    <span class="comment">/* out only */</span> <span class="keyword">vm_offset_t</span>            * logDataOut,</div><div class="line">    <span class="comment">/* out only */</span> <span class="keyword">mach_msg_type_number_t</span> * logDataLengthOut,</div><div class="line">    <span class="comment">/* out only */</span> <span class="keyword">kern_return_t</span>          * op_result)</div><div class="line">&#123;</div><div class="line">    result = vm_map_copyout(kernel_map, &amp;map_addr, (<span class="keyword">vm_map_copy_t</span>)requestIn);</div><div class="line">    ..</div><div class="line">    request = CAST_DOWN(<span class="keyword">char</span> *, map_addr);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (requestLengthIn &gt; <span class="keyword">sizeof</span>(mkext2_header)) &#123;</div><div class="line">        mkextHeader = (mkext2_header *)request;</div><div class="line">        <span class="keyword">if</span> (MKEXT_GET_MAGIC(mkextHeader) == MKEXT_MAGIC &amp;&amp;</div><div class="line">            MKEXT_GET_SIGNATURE(mkextHeader) == MKEXT_SIGN) &#123;</div><div class="line"></div><div class="line">            isMkext = <span class="literal">true</span>;    <span class="comment">//OK</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 传递一个 mkext 包。</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">    通过分析handleRequest 流程确定，当传入 Load Predicate 时，一定是 mkext 格式的数据，应为还没有加载只有 mkext 文件可以load</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (isMkext) &#123;</div><div class="line">...</div><div class="line">        *op_result = OSKext::loadFromMkext((OSKextLogSpec)clientLogSpec,</div><div class="line">            request, requestLengthIn,</div><div class="line">            &amp;logData, &amp;logDataLength);        <span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* defined(SECURE_KERNEL) */</span></span></div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="comment">// 或者传递一个  XML 文件 （略）</span></div><div class="line">    &#123;</div><div class="line">      *op_result = OSKext::handleRequest(hostPriv,</div><div class="line">            (OSKextLogSpec)clientLogSpec,</div><div class="line">            request, requestLengthIn,</div><div class="line">            &amp;response, &amp;responseLength,</div><div class="line">            &amp;logData, &amp;logDataLength);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">OSReturn</div><div class="line">OSKext::loadFromMkext((OSKextLogSpec)clientLogSpec,</div><div class="line">            request, requestLengthIn,</div><div class="line">            &amp;logData, &amp;logDataLength) &#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">   mkextData = OSData::withBytesNoCopy(mkextBuffer,</div><div class="line">        mkextBufferLength);</div><div class="line">...</div><div class="line">    result = readMkext2Archive(mkextData, &amp;mkextPlist, <span class="literal">NULL</span>);   <span class="comment">//</span></div><div class="line">...</div><div class="line">    <span class="comment">// 文本字符串</span></div><div class="line">    <span class="comment">// 获取 kext  的操作命令：Load</span></div><div class="line">    predicate = _OSKextGetRequestPredicate(mkextPlist);</div><div class="line"></div><div class="line">    <span class="comment">//检查　predicate是否是　“Load”, 这里 只处理 Load Predicate</span></div><div class="line">     <span class="keyword">if</span> (!predicate || !predicate-&gt;isEqualTo(kKextRequestPredicateLoad)) &#123;</div><div class="line">        OSKextLog(<span class="comment">/* kext */</span> <span class="literal">NULL</span>,</div><div class="line">            kOSKextLogErrorLevel |</div><div class="line">            kOSKextLogLoadFlag,</div><div class="line">            <span class="string">"Received kext load request with no predicate; skipping."</span>);</div><div class="line">        result = kOSKextReturnInvalidArgument;</div><div class="line">        <span class="keyword">goto</span> finish;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="comment">// 加载　info.plist　中的参数</span></div><div class="line">    requestArgs = OSDynamicCast(OSDictionary,</div><div class="line">        mkextPlist-&gt;getObject(kKextRequestArgumentsKey));</div><div class="line">...</div><div class="line">    <span class="comment">// 获取当前 kext 的 Bundle id （唯一标识）</span></div><div class="line">    kextIdentifier = OSDynamicCast(OSString,</div><div class="line">        requestArgs-&gt;getObject(kKextRequestArgumentBundleIdentifierKey));</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">/* Load the kext, with no deferral, since this is a load from outside</span></div><div class="line">    * the kernel.</div><div class="line">    * xxx - Would like a better way to handle the default values for the</div><div class="line">    * xxx - start/match opt args.</div><div class="line">    */</div><div class="line">    result = OSKext::loadKextWithIdentifier(    <span class="comment">//[通过Identifier来加载 kext ]</span></div><div class="line">        kextIdentifier,</div><div class="line">        <span class="comment">/* allowDefer */</span> <span class="literal">false</span>,     <span class="comment">//不支持 延迟加载</span></div><div class="line">        delayAutounload,</div><div class="line">        startKextExcludeLevel,</div><div class="line">        startMatchingExcludeLevel,</div><div class="line">        personalityNames);</div><div class="line">...</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下表是kext_request 支持的命令，这些命令保存在<code>Kext Request Predicate</code>键值中。</p>
<p><img src="/include/img/bk-xnu/kext-predicate.png" alt="predicate"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mkext2_header 成员</div><div class="line">    <span class="keyword">uint32_t</span>      magic;       \</div><div class="line">    <span class="keyword">uint32_t</span>      signature;   \</div><div class="line">    <span class="keyword">uint32_t</span>      length;      \</div><div class="line">    <span class="keyword">uint32_t</span>      adler32;     \</div><div class="line">    <span class="keyword">uint32_t</span>      version;     \</div><div class="line">    <span class="keyword">uint32_t</span>      numkexts;    \</div><div class="line">    <span class="keyword">cpu_type_t</span>    cputype;     \</div><div class="line">    <span class="keyword">cpu_subtype_t</span> cpusubtype;</div><div class="line"></div><div class="line">   <span class="keyword">uint32_t</span> plist_offset;</div><div class="line">    <span class="keyword">uint32_t</span> plist_compressed_size;</div><div class="line">    <span class="keyword">uint32_t</span> plist_full_size;</div></pre></td></tr></table></figure>
<p>从kext　中提取info.plist<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">OSReturn</div><div class="line">OSKext::readMkext2Archive(</div><div class="line">    OSData        * mkextData,</div><div class="line">    OSDictionary ** mkextPlistOut,</div><div class="line">    <span class="keyword">uint32_t</span>      * checksumPtr)   &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 获取mkext2_header的 plist_offset、plist_compressed_size、plist_full_size字段。</span></div><div class="line">    mkextPlistOffset = MKEXT2_GET_PLIST(mkextHeader);</div><div class="line">    mkextPlistCompressedSize = MKEXT2_GET_PLIST_COMPSIZE(mkextHeader);</div><div class="line">    mkextPlistEnd = (<span class="keyword">char</span> *)mkextHeader + mkextPlistOffset +</div><div class="line">        mkextPlistCompressedSize;</div><div class="line">    ...</div><div class="line"></div><div class="line">    mkextPlistFullSize = MKEXT2_GET_PLIST_FULLSIZE(mkextHeader);</div><div class="line"></div><div class="line">    <span class="comment">// 先不考虑压缩的情况</span></div><div class="line">    <span class="keyword">if</span> (mkextPlistCompressedSize) &#123;</div><div class="line">        ...</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mkextPlistDataBuffer = (<span class="keyword">const</span> <span class="keyword">char</span> *)mkextHeader + mkextPlistOffset;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    parsedXML = OSUnserializeXML(mkextPlistDataBuffer, &amp;errorString);</div><div class="line">    <span class="keyword">if</span> (parsedXML) &#123;</div><div class="line">        mkextPlist = OSDynamicCast(OSDictionary, parsedXML);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//mkextPlist 是一个字典</span></div><div class="line">    <span class="keyword">if</span> (!mkextPlist) &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">goto</span> finish;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="comment">// 上层 传入mkextPlistOut</span></div><div class="line">    <span class="keyword">if</span> (mkextPlistOut) &#123;</div><div class="line">        *mkextPlistOut = mkextPlist;</div><div class="line">        (*mkextPlistOut)-&gt;retain();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//提取 _MKEXTInfoDictionaries key 对应的数据</span></div><div class="line">    mkextInfoDictArray = OSDynamicCast(OSArray,</div><div class="line">        mkextPlist-&gt;getObject(kMKEXTInfoDictionariesKey));</div><div class="line">    ...</div><div class="line">        <span class="keyword">goto</span> finish;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    count = mkextInfoDictArray-&gt;getCount();</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        OSDictionary * infoDict;</div><div class="line"></div><div class="line"></div><div class="line">        infoDict = OSDynamicCast(OSDictionary,</div><div class="line">                                 mkextInfoDictArray-&gt;getObject(i));</div><div class="line">         ...</div><div class="line">         <span class="comment">// 这个 创建一个 newKext 对象，然后释放（计数器-1）。但是 系统还保留了 OSKext 在全局对象中</span></div><div class="line">        <span class="keyword">if</span> (infoDict) &#123;</div><div class="line">            OSKext * newKext = OSKext::withMkext2Info(infoDict, mkextData);</div><div class="line">            OSSafeReleaseNULL(newKext);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   <span class="comment">/* Even if we didn't keep any kexts from the mkext, we may have a load</span></div><div class="line">    * request to process, so we are successful (no errors occurred).</div><div class="line">    * 即使 我们没有 引用任何 kext, 我们还需要给进程发送一请求</div><div class="line">    */</div><div class="line">    result = kOSReturnSuccess;</div><div class="line"></div><div class="line">finish:</div><div class="line"></div><div class="line">    OSSafeReleaseNULL(parsedXML);</div><div class="line">    OSSafeReleaseNULL(mkextPlistUncompressedData);</div><div class="line">    OSSafeReleaseNULL(errorString);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>load kext 的代码， 这个函数有个重载函数 通过第一个参数可以区分。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">OSReturn</div><div class="line">OSKext::loadKextWithIdentifier(</div><div class="line">    OSString          * kextIdentifier,</div><div class="line">    Boolean             allowDeferFlag,</div><div class="line">    Boolean             delayAutounloadFlag,</div><div class="line">    OSKextExcludeLevel  startOpt,</div><div class="line">    OSKextExcludeLevel  startMatchingOpt,</div><div class="line">    OSArray           * personalityNames)</div><div class="line">&#123;</div><div class="line">    OSReturn          result               = kOSReturnError;</div><div class="line">    OSReturn          pingResult           = kOSReturnError;</div><div class="line">    OSKext          * theKext              = <span class="literal">NULL</span>;  <span class="comment">// do not release</span></div><div class="line">    OSDictionary    * loadRequest          = <span class="literal">NULL</span>;  <span class="comment">// must release</span></div><div class="line">    <span class="keyword">const</span> OSSymbol  * kextIdentifierSymbol = <span class="literal">NULL</span>;  <span class="comment">// must release</span></div><div class="line"></div><div class="line">    IORecursiveLockLock(sKextLock);</div><div class="line"></div><div class="line">    OSKext::recordIdentifierRequest(kextIdentifier);</div><div class="line"></div><div class="line">    theKext = OSDynamicCast(OSKext, sKextsByID-&gt;getObject(kextIdentifier));</div><div class="line">    <span class="keyword">if</span> (!theKext) &#123;</div><div class="line">        <span class="keyword">if</span> (!allowDeferFlag) &#123;</div><div class="line">...</div><div class="line">             <span class="keyword">goto</span> finish;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!sKernelRequestsEnabled) &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">goto</span> finish;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">       <span class="comment">/* Create a new request unless one is already sitting</span></div><div class="line">        * in sKernelRequests for this bundle identifier</div><div class="line">        * 创建一个 kernel 请求，请求去加载 kextIdentifier 对应的 kext</div><div class="line">        */</div><div class="line">        kextIdentifierSymbol = OSSymbol::withString(kextIdentifier);</div><div class="line">        <span class="keyword">if</span> (!sPostedKextLoadIdentifiers-&gt;containsObject(kextIdentifierSymbol)) &#123;</div><div class="line">            result = _OSKextCreateRequest(kKextRequestPredicateRequestLoad,   <span class="comment">//"Kext Load Request"</span></div><div class="line">                &amp;loadRequest);</div><div class="line">            <span class="keyword">if</span> (result != kOSReturnSuccess) &#123;</div><div class="line">                <span class="keyword">goto</span> finish;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!_OSKextSetRequestArgument(loadRequest,</div><div class="line">                kKextRequestArgumentBundleIdentifierKey, kextIdentifier)) &#123;</div><div class="line"></div><div class="line">                result = kOSKextReturnNoMemory;</div><div class="line">                <span class="keyword">goto</span> finish;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!sKernelRequests-&gt;setObject(loadRequest)) &#123;</div><div class="line">                result = kOSKextReturnNoMemory;</div><div class="line">                <span class="keyword">goto</span> finish;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!sPostedKextLoadIdentifiers-&gt;setObject(kextIdentifierSymbol)) &#123;</div><div class="line">                result = kOSKextReturnNoMemory;</div><div class="line">                <span class="keyword">goto</span> finish;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 查看是否可以 load kext</span></div><div class="line">        pingResult = OSKext::pingKextd();</div><div class="line">        <span class="keyword">if</span> (pingResult == kOSKextReturnDisabled) &#123;</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line">        result = kOSKextReturnDeferred;</div><div class="line">        <span class="keyword">goto</span> finish;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 调用 OSKext 的 load</span></div><div class="line">    result = theKext-&gt;load(startOpt, startMatchingOpt, personalityNames);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (result != kOSReturnSuccess) &#123;</div><div class="line">        ...</div><div class="line">        OSKext::removeKext(theKext,</div><div class="line">            <span class="comment">/* terminateService/removePersonalities */</span> <span class="literal">true</span>);</div><div class="line">        <span class="keyword">goto</span> finish;</div><div class="line">    &#125;</div><div class="line">...</div><div class="line">finish:</div><div class="line">    OSSafeReleaseNULL(loadRequest);</div><div class="line">    OSSafeReleaseNULL(kextIdentifierSymbol);</div><div class="line">    IORecursiveLockUnlock(sKextLock);</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#define kMKEXTInfoDictionariesKey             &quot;_MKEXTInfoDictionaries&quot;</div><div class="line"></div><div class="line">#define kMKEXTBundlePathKey                   &quot;_MKEXTBundlePath&quot;</div><div class="line">#define kMKEXTExecutableRelativePathKey       &quot;_MKEXTExecutableRelativePath&quot;</div><div class="line">#define kMKEXTExecutableKey                   &quot;_MKEXTExecutable&quot;</div><div class="line"></div><div class="line">#define kMKEXTLoadRequestKey                  &quot;_MKEXTLoadRequest&quot;</div><div class="line">#define kMKEXTLoadRequestLoadKey              &quot;Load Kext&quot;</div><div class="line">#define kMKEXTLoadRequestStartKey             &quot;Start Kext&quot;</div><div class="line">#define kMKEXTLoadRequestAddPersonalitiesKey  &quot;Add Personalities&quot;</div><div class="line">#define kMKEXTLoadRequestDisableAutounloadKey &quot;Disable Autounload&quot;</div><div class="line"></div><div class="line">#define kKextRequestPredicateLoad                  &quot;Load&quot;</div></pre></td></tr></table></figure>
<p>总结一番：</p>
<ol>
<li><p>kext_request 的参数 requestIn的类型</p>
<ul>
<li>当 kextd 发出 load请求时, 向kext_request 发送一个 mkext文件</li>
<li>当 kextd 发出start/stop/…其他请求时,向kext_request 发送一个 XML文件</li>
</ul>
</li>
<li><p>mkext <code>Load</code> 需要2个过程，L1 阶段是从 mkext 中获取 Plist 以后就创建 OSKext 对象，并保存在 sKextsByID 字典中。L2 阶段从sKextsByID 中取出 OSKext，并调用 <code>OSKext-&gt;load</code> 方法</p>
</li>
<li><code>OSKext::initialize</code> 中给 kernel 创建 OSKext, 并初始化kext 全局管理对象（<code>sKextsByID, g_kernel_kmod_info, sLoadedKexts 等</code>）</li>
<li>当kext_request 发送 <code>Start</code> 时， 最终调用到<code>OSKext::start</code> 函数内, 会将控制权交给 kext的 xxx_start方法</li>
</ol>
<p>3/4 条会在下一篇中 给出代码分析。<br><img src="/include/img/bk-xnu/OSKext-initialize.png" alt="OSKext::initialize"></p>
<h4 id="调试-kext-request"><a href="#调试-kext-request" class="headerlink" title="调试 kext_request"></a>调试 kext_request</h4><p>这里调试的是 libsystem_kernel.dylib 中的kext_request 代码通过 mach msg 发送消息给上一节分析的是 xnu 内核中的 kext_request 代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">第一次请求</div><div class="line">0x7fe4e2805400: &quot;&lt;dict&gt;&lt;key&gt;Kext Request Predicate&lt;/key&gt;&lt;string&gt;Get Loaded Kext Info&lt;/string&gt;&lt;key&gt;Kext Request Arguments&lt;/key&gt;&lt;dict&gt;&lt;key&gt;Kext Request Info Keys&lt;/key&gt;&lt;array&gt;&lt;string&gt;CFBundleIdentifier&lt;/string&gt;&lt;string&gt;CFBundleVersion&lt;/string&gt;&lt;string&gt;OSBundleCompatibleVersion&lt;/string&gt;&lt;string&gt;OSBundleIsInterface&lt;/string&gt;&lt;string&gt;OSKernelResource&lt;/string&gt;&lt;string&gt;OSBundleCPUType&lt;/string&gt;&lt;string&gt;OSBundleCPUSubtype&lt;/string&gt;&lt;string&gt;OSBundlePath&lt;/string&gt;&lt;string&gt;OSBundleUUID&lt;/string&gt;&lt;string&gt;OSBundleStarted&lt;/string&gt;&lt;string&gt;OSBundleLoadTag&lt;/string&gt;&lt;string&gt;OSBundleLoadAddress&lt;/string&gt;&lt;string&gt;OSBundleLoadSize&lt;/string&gt;&lt;string&gt;OSBundleWiredSize&lt;/string&gt;&lt;string&gt;OSBundlePrelinked&lt;/string&gt;&lt;string&gt;OSBundleDependencies&lt;/string&gt;&lt;string&gt;OSBundleRetainCount&lt;/string&gt;&lt;/array&gt;&lt;key&gt;CFBundleIdentifier&lt;/key&gt;&lt;array&gt;&lt;string&gt;com.apple.driver.KextExcludeList&lt;/string&gt;&lt;/array&gt;&lt;/dict&gt;&lt;/dict&gt;&quot;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">第三次</div><div class="line">&lt;dict&gt;</div><div class="line">  &lt;key&gt;Kext Request Predicate&lt;/key&gt;</div><div class="line">  &lt;string&gt;Load&lt;/string&gt;</div><div class="line">  &lt;key&gt;Kext Request Arguments&lt;/key&gt;</div><div class="line">  &lt;dict&gt;</div><div class="line">    &lt;key&gt;Start Exclude Level&lt;/key&gt;</div><div class="line">    &lt;integer ID=&quot;0&quot; size=&quot;8&quot;&gt;0x0&lt;/integer&gt;</div><div class="line">    &lt;key&gt;Start Matching Exclude Level&lt;/key&gt;</div><div class="line">    &lt;integer IDREF=&quot;0&quot; /&gt;</div><div class="line">    &lt;key&gt;CFBundleIdentifier&lt;/key&gt;</div><div class="line">    &lt;string ID=&quot;1&quot;&gt;com.apple.filesystems.ntfs&lt;/string&gt;</div><div class="line">  &lt;/dict&gt;</div><div class="line">  &lt;key&gt;_MKEXTInfoDictionaries&lt;/key&gt;</div><div class="line">  &lt;array&gt;</div><div class="line">    &lt;dict&gt;</div><div class="line">      &lt;key&gt;CFBundleName&lt;/key&gt;</div><div class="line">      &lt;string&gt;NTFS File System Extension&lt;/string&gt;</div><div class="line">      &lt;key&gt;DTXcode&lt;/key&gt;</div><div class="line">      &lt;string&gt;0720&lt;/string&gt;</div><div class="line">      &lt;key&gt;DTSDKName&lt;/key&gt;</div><div class="line">      &lt;string&gt;macosx10.11internal&lt;/string&gt;</div><div class="line">      &lt;key&gt;DTSDKBuild&lt;/key&gt;</div><div class="line">      &lt;string&gt;15C45&lt;/string&gt;</div><div class="line">      &lt;key&gt;CFBundleDevelopmentRegion&lt;/key&gt;</div><div class="line">      &lt;string&gt;English&lt;/string&gt;</div><div class="line">      &lt;key&gt;CFBundleVersion&lt;/key&gt;</div><div class="line">      &lt;string ID=&quot;2&quot;&gt;3.13&lt;/string&gt;</div><div class="line">      &lt;key&gt;BuildMachineOSBuild&lt;/key&gt;</div><div class="line">      &lt;string&gt;15A284&lt;/string&gt;</div><div class="line">      &lt;key&gt;_MKEXTExecutableRelativePath&lt;/key&gt;</div><div class="line">      &lt;string&gt;Contents/MacOS/ntfs&lt;/string&gt;</div><div class="line">      &lt;key&gt;CFBundlePackageType&lt;/key&gt;</div><div class="line">      &lt;string&gt;KEXT&lt;/string&gt;</div><div class="line">      &lt;key&gt;CFBundleShortVersionString&lt;/key&gt;</div><div class="line">      &lt;string IDREF=&quot;2&quot; /&gt;</div><div class="line">      &lt;key&gt;CFBundleSupportedPlatforms&lt;/key&gt;</div><div class="line">      &lt;array&gt;</div><div class="line">        &lt;string&gt;MacOSX&lt;/string&gt;</div><div class="line">      &lt;/array&gt;</div><div class="line">      &lt;key&gt;CFBundleInfoDictionaryVersion&lt;/key&gt;</div><div class="line">    &lt;/dict&gt;</div><div class="line">  &lt;/array&gt;</div><div class="line">&lt;/dict&gt;</div></pre></td></tr></table></figure>
<h3 id="kext-相关工具"><a href="#kext-相关工具" class="headerlink" title="kext 相关工具"></a>kext 相关工具</h3><h4 id="第三方工具"><a href="#第三方工具" class="headerlink" title="第三方工具"></a>第三方工具</h4><table>
<thead>
<tr>
<th>命令</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>jtool</td>
<td>分析 Mach-O格式</td>
</tr>
<tr>
<td>joker</td>
<td>(不能用）</td>
</tr>
</tbody>
</table>
<p>联动内核？ 直接使用物理内存</p>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><table>
<thead>
<tr>
<th>命令</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>kextd</td>
<td>用户空动态加载kext 的守护进程，被 launchd 启动</td>
</tr>
<tr>
<td>kextfind</td>
<td>通过属性 和 标准查询 kext</td>
</tr>
<tr>
<td>kextlibs</td>
<td>解析 kext的依赖</td>
</tr>
<tr>
<td>kextload</td>
<td>kext 加载器</td>
</tr>
<tr>
<td>kextunload</td>
<td>kext 卸载器</td>
</tr>
<tr>
<td>kextutil</td>
<td>检查 kext 的 bug, 等功能</td>
</tr>
<tr>
<td>kextstat</td>
<td>查看已经安装的 kext</td>
</tr>
<tr>
<td>————–</td>
<td>————–</td>
</tr>
<tr>
<td>ioreg</td>
<td>show I/O Kit registry，”man ioreg”</td>
</tr>
<tr>
<td>ioclasscount</td>
<td>内核对象的内存管理是基于引用计数，该工具可以用来打印所有已加载的内核对象的引用计数个数，便于调试内存泄露</td>
</tr>
<tr>
<td>sudo zprint</td>
<td>查看 kalloc 分配的內存域 (类似于 slab 缓存)</td>
</tr>
<tr>
<td>Console</td>
<td>查看 system.log</td>
</tr>
<tr>
<td>IORegistryExplorer</td>
<td>查看 kext IOLog 輸出信息</td>
</tr>
<tr>
<td>USB Prober</td>
<td>查看 usb 使用情況</td>
</tr>
<tr>
<td>————–</td>
<td>————–</td>
</tr>
<tr>
<td>mkextunpack</td>
<td>解包 mkext</td>
</tr>
<tr>
<td>kextcache</td>
</tr>
</tbody>
</table>
<h4 id="kextstat"><a href="#kextstat" class="headerlink" title="kextstat"></a>kextstat</h4><p>kextstat 查看系统(/System/Library/Extensions下的 kext 不一定全部加载了)当前加载的 kext。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">blog git:(master) ✗ kextstat</div><div class="line">Index Refs Address            Size       Wired      Name (Version) UUID &lt;Linked Against&gt;</div><div class="line">    1   94 0xffffff7f80a46000 0x9d30     0x9d30     com.apple.kpi.bsd (16.4.0) 548007FE-B217-4499-8640-238BC24F4A17</div><div class="line">    2    8 0xffffff7f80e59000 0x3940     0x3940     com.apple.kpi.dsep (16.4.0) 38FEF282-1288-42F3-8E55-EDD04053B20B</div><div class="line">    3  119 0xffffff7f80a04000 0x21040    0x21040    com.apple.kpi.iokit (16.4.0) EA3A39EE-499F-44C3-88F2-334FEB308226</div><div class="line">    4  126 0xffffff7f80a26000 0xd200     0xd200     com.apple.kpi.libkern (16.4.0) 677B5452-B294-43D3-A562-F13502C04C54</div><div class="line">    5  114 0xffffff7f80a00000 0x3dd0     0x3dd0     com.apple.kpi.mach (16.4.0) 2A128386-C535-4026-B9D7-E91D3360CEF4</div><div class="line">    6   62 0xffffff7f80a34000 0xba10     0xba10     com.apple.kpi.private (16.4.0) F8C31C2F-2831-4680-90DF-97A2EA6DE9F0</div><div class="line">    7   76 0xffffff7f80a40000 0x5890     0x5890     com.apple.kpi.unsupported (16.4.0) C8C39C9E-83FE-4274-BA90-9535845EFF9C</div><div class="line">    8    7 0xffffff7f80e60000 0xa9000    0xa9000    com.apple.kec.corecrypto (1.0) 25C67059-A2B6-328F-BCCF-F81CC7FFC10F &lt;7 6 5 4 3 1&gt;</div><div class="line">    9    0 0xffffff7f80fbb000 0xf000     0xf000     com.apple.kec.pthread (1) 479F2E9E-1F15-3D76-A407-DB04C1277527 &lt;7 6 5 4 1&gt;</div><div class="line">   10    1 0xffffff7f80ff1000 0xb000     0xb000     com.apple.kec.Libm (1) 51D82C5F-0248-334D-ADC6-5861BBB83C97 &lt;4&gt;</div><div class="line">   11   27 0xffffff7f80ffc000 0x9000     0x9000     com.apple.iokit.IOACPIFamily (1.4) 4F7FB6AD-2498-3F71-827C-ED7AA4BF2511 &lt;7 6 4 3&gt;</div><div class="line">   12   30 0xffffff7f80b32000 0x34000    0x34000    com.apple.iokit.IOPCIFamily (2.9) 57960DC6-4099-31BC-9B47-52CD647779C7 &lt;7 6 5 4 3&gt;</div><div class="line">   13    2 0xffffff7f831d7000 0x60000    0x60000    com.apple.driver.AppleACPIPlatform (5.0) 867C81BE-EA01-3A65-89F4-06D78E6514CA &lt;12 11 7 6 5 4 3 1&gt;</div><div class="line">   14    1 0xffffff7f812ae000 0xb000     0xb000     com.apple.driver.AppleFDEKeyStore (28.30) EA5D0966-E8EA-337A-98EB-195806E8F723 &lt;8 7 6 5 4 3 1&gt;</div><div class="line">   15    4 0xffffff7f816a9000 0x7000     0x7000     com.apple.iokit.IOReportFamily (31) B14DC3D3-7250-3DA3-BF50-C666EBEDAF4C &lt;5 4 3&gt;</div><div class="line">   16    7 0xffffff7f80a50000 0x27000    0x27000    com.apple.iokit.IOStorageFamily (2.1) 3238C6A2-A948-378E-9C53-3883089C1B52 &lt;7 6 5 4 3 1&gt;</div><div class="line">   17    0 0xffffff7f81779000 0x190</div></pre></td></tr></table></figure></p>
<p>第1列 Index是 kext 在表中的索引<br>第2列 Refs 显示当前 kext 依赖的 kext 的个数，每一项末尾尖括号&lt;&gt;内是依赖的 kext 的index。</p>
<p>从依赖关系树状图可以看出，树根部是1-7这7个 kext（kpi.*）</p>
<h4 id="zprint"><a href="#zprint" class="headerlink" title="zprint"></a>zprint</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">sh-3.2# zprint | grep port</div><div class="line"></div><div class="line">                    elem         cur         max        cur         max         cur  alloc  alloc</div><div class="line">zone name                   size        size        size      #elts       #elts       inuse   size  count</div><div class="line"></div><div class="line">ipc.ports                    336       2072K      24924K       6314       75958        5779     4K     12   C</div><div class="line">ipc.port.sets                 88         40K       1868K        465       21736         388     8K     93   C</div><div class="line">ipc.task.importance          168         24K       4032K        146       24576         106    12K     73   C</div><div class="line">ipc.importance.inherit        88          8K       2112K         93       24576           2     8K     93   C</div><div class="line">com.apple.iokit.IOReportFamily</div></pre></td></tr></table></figure>
<h3 id="Change-Log"><a href="#Change-Log" class="headerlink" title="Change Log"></a>Change Log</h3><table>
<thead>
<tr>
<th>Time</th>
<th>Change</th>
</tr>
</thead>
<tbody>
<tr>
<td>2017-03-17</td>
<td>kext_request Load源代码分析</td>
</tr>
<tr>
<td>2017-03-20</td>
<td>梳理文章, 下一篇专门分析 OSKext 中的几个函数 load, start,withMkext2Info…</td>
</tr>
</tbody>
</table>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/03/15/XNU内核设计-Kext内核扩展/" data-id="cj1zuv7bc001vtev2zbra9px1" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/2017/03/16/OSX-FirstExtension-开发/" class="pre">OSX FirstExtension 开发</a><a href="/2017/03/15/3月逻辑思维/" class="next">3月逻辑思维</a></div><div data-thread-key="2017/03/15/XNU内核设计-Kext内核扩展/" data-title="XNU内核设计--Kext内核扩展" data-url="http://yoursite.com/2017/03/15/XNU内核设计-Kext内核扩展/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2017/03/15/XNU内核设计-Kext内核扩展/" data-title="XNU内核设计--Kext内核扩展" data-url="http://yoursite.com/2017/03/15/XNU内核设计-Kext内核扩展/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/开发/">开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/categories-fiddle/">捣鼓</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/categories-exploit/">漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/categories-life/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/categories-research/">研究</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/逆向/">逆向</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/逻辑思维/" style="font-size: 15px;">逻辑思维</a> <a href="/tags/hook/" style="font-size: 15px;">hook</a> <a href="/tags/了解/" style="font-size: 15px;">了解</a> <a href="/tags/xnu/" style="font-size: 15px;">xnu</a> <a href="/tags/kext/" style="font-size: 15px;">kext</a> <a href="/tags/mach/" style="font-size: 15px;">mach</a> <a href="/tags/public-intelligence/" style="font-size: 15px;">public intelligence</a> <a href="/tags/熟悉/" style="font-size: 15px;">熟悉</a> <a href="/tags/blackhat-2016/" style="font-size: 15px;">blackhat-2016</a> <a href="/tags/抓包/" style="font-size: 15px;">抓包</a> <a href="/tags/https/" style="font-size: 15px;">https</a> <a href="/tags/pi/" style="font-size: 15px;">pi</a> <a href="/tags/c/" style="font-size: 15px;">c</a> <a href="/tags/frida/" style="font-size: 15px;">frida</a> <a href="/tags/ios/" style="font-size: 15px;">ios</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/jeb/" style="font-size: 15px;">jeb</a> <a href="/tags/动态调试/" style="font-size: 15px;">动态调试</a> <a href="/tags/Armv8-64/" style="font-size: 15px;">Armv8-64</a> <a href="/tags/魔方/" style="font-size: 15px;">魔方</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/ios-osx/" style="font-size: 15px;">ios/osx</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/cocoa-app/" style="font-size: 15px;">cocoa app</a> <a href="/tags/AppVeyor/" style="font-size: 15px;">AppVeyor</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/27/CVE-2017-0561-高通wifi-soc的RCE攻击案例/">CVE-2017-0561高通wifi-soc的RCE攻击案例</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/19/《三体》/">《三体》</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/19/玩转-android-虚拟机/">玩转 android 虚拟机</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/10/Andorid-添加系统证书/">Andorid 添加系统证书</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/10/frida hook 操作手册/">Frida Hook 操作手册</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/28/Android-ELF-文件加壳/">Android ELF 文件加壳</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/java-ArrayList-String-add-用法说明/">java ArrayList<String>(){{add();}}; 用法说明</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/18/五阶魔方/">五阶魔方</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/逆向分析-cocoa-App/">逆向分析 cocoa App</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/OSX-FirstExtension-开发/">OSX FirstExtension 开发</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 资源链接</i></div><ul></ul><a href="http://bbs.pediy.com/" title="看雪论坛" target="_blank">看雪论坛</a><ul></ul><a href="http://ddeville.me/" title="Damien DeVille" target="_blank">Damien DeVille</a><ul></ul><a href="http://nirvan.360.cn/blog/?cat=2" title="360Nirvan Team" target="_blank">360Nirvan Team</a><ul></ul><a href="https://googleprojectzero.blogspot.jp/" title="Project Zero" target="_blank">Project Zero</a><ul></ul><a href="http://shell-storm.org/blog/Triton-under-the-hood/" title="Jonathan Salwan" target="_blank">Jonathan Salwan</a><ul></ul><a href="http://cocoahuke.com/" title="Cocoa ‘for iOS/Mac’" target="_blank">Cocoa ‘for iOS/Mac’</a><ul></ul><a href="http://whereisk0shl.top/" title="whereisk0shl" target="_blank">whereisk0shl</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">FloatingGuy's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'floatingguy'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?0550af547bfca45329cbf2afcc9fde43";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>